<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLOB Engine Demo</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    h2 { color: #555; margin-top: 30px; }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .panel {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
    }

    .order-book {
      font-family: monospace;
      font-size: 14px;
    }

    .price-level {
      display: flex;
      justify-content: space-between;
      padding: 4px 8px;
      border-bottom: 1px solid #e0e0e0;
    }

    .price-level:last-child {
      border-bottom: none;
    }

    .bid { color: #2ecc71; }
    .ask { color: #e74c3c; }
    .spread { color: #f39c12; font-weight: bold; }

    .stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .stat {
      background: white;
      padding: 10px 15px;
      border-radius: 4px;
      flex: 1;
    }

    .stat-label {
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
    }

    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }

    .trade-log {
      max-height: 300px;
      overflow-y: auto;
      background: #1a1a1a;
      color: #0f0;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
    }

    .btn-success {
      background: #2ecc71;
      color: white;
    }

    .btn-success:hover {
      background: #27ae60;
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .trader-list {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .trader {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      background: white;
      margin-bottom: 4px;
      border-radius: 4px;
      font-size: 13px;
    }

    .depth-chart {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-top: 20px;
    }

    .depth-bar {
      height: 20px;
      position: relative;
      background: #eee;
      border-radius: 3px;
    }

    .depth-bid {
      background: linear-gradient(to right, #27ae60, #2ecc71);
      height: 100%;
      position: absolute;
      left: 0;
      border-radius: 3px 0 0 3px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 5px;
      color: white;
      font-size: 11px;
    }

    .depth-ask {
      background: linear-gradient(to right, #e74c3c, #c0392b);
      height: 100%;
      position: absolute;
      left: 0;
      border-radius: 3px;
      display: flex;
      align-items: center;
      padding-left: 5px;
      color: white;
      font-size: 11px;
    }

    .depth-center {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      color: #666;
      background: white;
      padding: 2px 4px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ“Š CLOB (Central Limit Order Book) Engine Demo</h1>
    <p>A pure deterministic order book matching engine with price-time priority (FIFO at each price level).</p>

    <div class="stats">
      <div class="stat">
        <div class="stat-label">Best Bid</div>
        <div class="stat-value" id="bestBid">--</div>
      </div>
      <div class="stat">
        <div class="stat-label">Best Ask</div>
        <div class="stat-value" id="bestAsk">--</div>
      </div>
      <div class="stat">
        <div class="stat-label">Spread</div>
        <div class="stat-value" id="spread">--</div>
      </div>
      <div class="stat">
        <div class="stat-label">Mid Price</div>
        <div class="stat-value" id="midPrice">--</div>
      </div>
      <div class="stat">
        <div class="stat-label">Total Trades</div>
        <div class="stat-value" id="totalTrades">0</div>
      </div>
    </div>

    <div class="grid">
      <!-- Order Placement -->
      <div class="panel">
        <h2>Place Order</h2>
        <div class="form-group">
          <label>Order Type</label>
          <select id="orderType">
            <option value="LIMIT">Limit Order</option>
            <option value="MARKET">Market Order</option>
          </select>
        </div>
        <div class="form-group">
          <label>Side</label>
          <select id="side">
            <option value="BUY">Buy (Bid)</option>
            <option value="SELL">Sell (Ask)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Trader</label>
          <select id="traderId">
            <option value="alice">Alice</option>
            <option value="bob">Bob</option>
            <option value="carol">Carol</option>
            <option value="dave">Dave</option>
          </select>
        </div>
        <div class="form-group">
          <label>Price (for Limit Orders)</label>
          <input type="number" id="price" step="0.01" min="0.01" max="0.99" value="0.50">
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" id="qty" min="1" max="1000" value="10">
        </div>
        <div class="btn-group">
          <button class="btn-primary" onclick="placeOrder()">Place Order</button>
          <button class="btn-warning" onclick="resetMarket()">Reset Market</button>
        </div>

        <div class="depth-chart" id="depthChart">
          <!-- Depth bars will be rendered here -->
        </div>
      </div>

      <!-- Order Book & Trades -->
      <div class="panel">
        <h2>Order Book</h2>
        <div class="order-book" id="orderBook">
          <div style="text-align: center; color: #999;">Empty - Place some orders</div>
        </div>

        <h2 style="margin-top: 30px;">Trade Log</h2>
        <div class="trade-log" id="tradeLog">
          <div>// Trades will appear here...</div>
        </div>
      </div>
    </div>

    <!-- Trader States -->
    <div class="panel" style="margin-top: 20px;">
      <h2>Trader States</h2>
      <div class="trader-list" id="traderStates">
        <!-- Trader states will be rendered here -->
      </div>
    </div>
  </div>

  <script type="module">
    // Simple CLOB Engine Implementation in JS
    class SimpleCLOB {
      constructor() {
        this.bids = new Map(); // price -> [{orderId, traderId, qty, timestamp}]
        this.asks = new Map();
        this.traders = new Map([
          ['alice', {cash: 10000, yesShares: 0}],
          ['bob', {cash: 10000, yesShares: 0}],
          ['carol', {cash: 10000, yesShares: 0}],
          ['dave', {cash: 10000, yesShares: 0}]
        ]);
        this.trades = [];
        this.orderIdCounter = 0;
        this.tradeIdCounter = 0;
      }

      _sortPrices(map, desc = false) {
        return Array.from(map.keys()).map(Number).sort((a, b) => desc ? b - a : a - b);
      }

      getBestBid() {
        const prices = this._sortPrices(this.bids, true);
        return prices.length > 0 ? prices[0] : null;
      }

      getBestAsk() {
        const prices = this._sortPrices(this.asks, false);
        return prices.length > 0 ? prices[0] : null;
      }

      getSpread() {
        const bid = this.getBestBid();
        const ask = this.getBestAsk();
        if (bid !== null && ask !== null) {
          return ask - bid;
        }
        return null;
      }

      getMidPrice() {
        const bid = this.getBestBid();
        const ask = this.getBestAsk();
        if (bid !== null && ask !== null) {
          return (bid + ask) / 2;
        }
        return null;
      }

      placeLimitOrder(traderId, side, price, qty) {
        const orderId = `ORD-${String(++this.orderIdCounter).padStart(6, '0')}`;
        const timestamp = Date.now();

        if (side === 'BUY') {
          // Check if crosses spread
          const bestAsk = this.getBestAsk();
          let filledQty = 0;

          if (bestAsk !== null && price >= bestAsk) {
            // Cross with asks
            const askPrices = this._sortPrices(this.asks, false);
            for (const askPrice of askPrices) {
              if (filledQty >= qty || askPrice > price) break;
              const level = this.asks.get(String(askPrice));

              for (let i = level.length - 1; i >= 0; i--) {
                if (filledQty >= qty) break;
                const order = level[i];
                const fillQty = Math.min(qty - filledQty, order.qty);

                if (fillQty > 0) {
                  this._executeTrade(order.traderId, traderId, askPrice, fillQty);
                  order.qty -= fillQty;
                  filledQty += fillQty;
                  level.splice(i, 1);
                }
              }

              // Update level
              const remaining = level.reduce((sum, o) => sum + o.qty, 0);
              if (remaining === 0) {
                this.asks.delete(String(askPrice));
              }
            }
          }

          // Add remaining to book
          if (filledQty < qty) {
            const priceKey = String(price);
            if (!this.bids.has(priceKey)) {
              this.bids.set(priceKey, []);
            }
            this.bids.get(priceKey).push({
              orderId,
              traderId,
              qty: qty - filledQty,
              timestamp
            });
          }
        } else {
          // SELL
          const bestBid = this.getBestBid();
          let filledQty = 0;

          if (bestBid !== null && price <= bestBid) {
            // Cross with bids
            const bidPrices = this._sortPrices(this.bids, true);
            for (const bidPrice of bidPrices) {
              if (filledQty >= qty || bidPrice < price) break;
              const level = this.bids.get(String(bidPrice));

              for (let i = level.length - 1; i >= 0; i--) {
                if (filledQty >= qty) break;
                const order = level[i];
                const fillQty = Math.min(qty - filledQty, order.qty);

                if (fillQty > 0) {
                  this._executeTrade(traderId, order.traderId, bidPrice, fillQty);
                  order.qty -= fillQty;
                  filledQty += fillQty;
                  level.splice(i, 1);
                }
              }

              const remaining = level.reduce((sum, o) => sum + o.qty, 0);
              if (remaining === 0) {
                this.bids.delete(String(bidPrice));
              }
            }
          }

          if (filledQty < qty) {
            const priceKey = String(price);
            if (!this.asks.has(priceKey)) {
              this.asks.set(priceKey, []);
            }
            this.asks.get(priceKey).push({
              orderId,
              traderId,
              qty: qty - filledQty,
              timestamp
            });
          }
        }

        return { orderId, filledQty, remainingQty: qty - filledQty };
      }

      placeMarketOrder(traderId, side, qty) {
        if (side === 'BUY') {
          const askPrices = this._sortPrices(this.asks, false);
          let filledQty = 0;

          for (const askPrice of askPrices) {
            if (filledQty >= qty) break;
            const level = this.asks.get(String(askPrice));

            for (let i = level.length - 1; i >= 0; i--) {
              if (filledQty >= qty) break;
              const order = level[i];
              const fillQty = Math.min(qty - filledQty, order.qty);

              if (fillQty > 0) {
                this._executeTrade(order.traderId, traderId, askPrice, fillQty);
                order.qty -= fillQty;
                filledQty += fillQty;
                level.splice(i, 1);
              }
            }

            const remaining = level.reduce((sum, o) => sum + o.qty, 0);
            if (remaining === 0) {
              this.asks.delete(String(askPrice));
            }
          }

          return { filledQty, remainingQty: qty - filledQty };
        } else {
          const bidPrices = this._sortPrices(this.bids, true);
          let filledQty = 0;

          for (const bidPrice of bidPrices) {
            if (filledQty >= qty) break;
            const level = this.bids.get(String(bidPrice));

            for (let i = level.length - 1; i >= 0; i--) {
              if (filledQty >= qty) break;
              const order = level[i];
              const fillQty = Math.min(qty - filledQty, order.qty);

              if (fillQty > 0) {
                this._executeTrade(traderId, order.traderId, bidPrice, fillQty);
                order.qty -= fillQty;
                filledQty += fillQty;
                level.splice(i, 1);
              }
            }

            const remaining = level.reduce((sum, o) => sum + o.qty, 0);
            if (remaining === 0) {
              this.bids.delete(String(bidPrice));
            }
          }

          return { filledQty, remainingQty: qty - filledQty };
        }
      }

      _executeTrade(bidTraderId, askTraderId, price, qty) {
        const trader = this.traders.get(askTraderId);
        trader.cash += price * qty;
        trader.yesShares -= qty;

        const bidTrader = this.traders.get(bidTraderId);
        bidTrader.cash -= price * qty;
        bidTrader.yesShares += qty;

        this.trades.push({
          tradeId: `TRD-${String(++this.tradeIdCounter).padStart(6, '0')}`,
          price,
          qty,
          bidTraderId,
          askTraderId,
          timestamp: Date.now()
        });
      }

      getDepth(side, ticks) {
        const map = side === 'BUY' ? this.bids : this.asks;
        const prices = this._sortPrices(map, side === 'BUY');
        let depth = 0;

        for (let i = 0; i < Math.min(ticks, prices.length); i++) {
          const level = map.get(String(prices[i]));
          if (level) {
            depth += level.reduce((sum, o) => sum + o.qty, 0);
          }
        }

        return depth;
      }

      getOrderBookSnapshot() {
        const bids = [];
        const asks = [];

        const bidPrices = this._sortPrices(this.bids, true);
        for (const price of bidPrices) {
          const level = this.bids.get(String(price));
          const totalQty = level.reduce((sum, o) => sum + o.qty, 0);
          bids.push({ price, totalQty });
        }

        const askPrices = this._sortPrices(this.asks, false);
        for (const price of askPrices) {
          const level = this.asks.get(String(price));
          const totalQty = level.reduce((sum, o) => sum + o.qty, 0);
          asks.push({ price, totalQty });
        }

        return { bids, asks };
      }
    }

    // Initialize CLOB
    const clob = new SimpleCLOB();

    // Update UI functions
    function updateUI() {
      const bestBid = clob.getBestBid();
      const bestAsk = clob.getBestAsk();
      const spread = clob.getSpread();
      const midPrice = clob.getMidPrice();

      document.getElementById('bestBid').textContent = bestBid !== null ? bestBid.toFixed(2) : '--';
      document.getElementById('bestAsk').textContent = bestAsk !== null ? bestAsk.toFixed(2) : '--';
      document.getElementById('spread').textContent = spread !== null ? spread.toFixed(4) : '--';
      document.getElementById('midPrice').textContent = midPrice !== null ? midPrice.toFixed(4) : '--';
      document.getElementById('totalTrades').textContent = clob.trades.length;

      // Update order book display
      const snapshot = clob.getOrderBookSnapshot();
      let bookHTML = '';

      // Show asks (reversed - best at top)
      for (let i = snapshot.asks.length - 1; i >= 0; i--) {
        const level = snapshot.asks[i];
        bookHTML += `<div class="price-level"><span class="ask">ASK ${level.price.toFixed(2)}</span><span>${level.totalQty.toFixed(0)} @ ${level.price.toFixed(2)}</span></div>`;
      }

      // Spread
      if (spread !== null) {
        bookHTML += `<div class="price-level spread">SPREAD ${spread.toFixed(4)}</div>`;
      }

      // Show bids
      for (const level of snapshot.bids) {
        bookHTML += `<div class="price-level"><span class="bid">BID ${level.price.toFixed(2)}</span><span>${level.totalQty.toFixed(0)} @ ${level.price.toFixed(2)}</span></div>`;
      }

      if (bookHTML === '') {
        bookHTML = '<div style="text-align: center; color: #999;">Empty - Place some orders</div>';
      }
      document.getElementById('orderBook').innerHTML = bookHTML;

      // Update depth chart
      updateDepthChart(snapshot);

      // Update trade log
      const logEl = document.getElementById('tradeLog');
      if (clob.trades.length === 0) {
        logEl.innerHTML = '<div>// Trades will appear here...</div>';
      } else {
        logEl.innerHTML = clob.trades.slice(-20).map(t =>
          `[${t.tradeId}] ${t.bidTraderId} â† ${t.askTraderId} | ${t.qty.toFixed(1)} @ $${t.price.toFixed(2)}`
        ).join('\n');
        logEl.scrollTop = logEl.scrollHeight;
      }

      // Update trader states
      updateTraderStates();
    }

    function updateDepthChart(snapshot) {
      let chartHTML = '';
      const maxBidQty = Math.max(...snapshot.bids.map(b => b.totalQty), 1);
      const maxAskQty = Math.max(...snapshot.asks.map(a => a.totalQty), 1);
      const maxQty = Math.max(maxBidQty, maxAskQty);

      // Bid depth
      for (let i = Math.min(5, snapshot.bids.length) - 1; i >= 0; i--) {
        const level = snapshot.bids[i];
        const pct = (level.totalQty / maxQty) * 100;
        chartHTML += `<div class="depth-bar">
          <div class="depth-bid" style="width: ${pct}%">${level.totalQty.toFixed(0)} @ ${level.price.toFixed(2)}</div>
        </div>`;
      }

      // Center (mid price)
      chartHTML += `<div class="depth-bar" style="height: 30px; background: #f39c12;">
        <div class="depth-center">MID ${clob.getMidPrice()?.toFixed(2) || '--'}</div>
      </div>`;

      // Ask depth
      for (let i = 0; i < Math.min(5, snapshot.asks.length); i++) {
        const level = snapshot.asks[i];
        const pct = (level.totalQty / maxQty) * 100;
        chartHTML += `<div class="depth-bar">
          <div class="depth-ask" style="width: ${pct}%">${level.totalQty.toFixed(0)} @ ${level.price.toFixed(2)}</div>
        </div>`;
      }

      document.getElementById('depthChart').innerHTML = chartHTML;
    }

    function updateTraderStates() {
      let html = '';
      for (const [id, trader] of clob.traders) {
        html += `
          <div class="trader">
            <span><strong>${id}</strong></span>
            <span>Cash: $${trader.cash.toFixed(2)}</span>
            <span>YES: ${trader.yesShares.toFixed(1)}</span>
          </div>
        `;
      }
      document.getElementById('traderStates').innerHTML = html;
    }

    // Global functions for button clicks
    window.placeOrder = function() {
      const orderType = document.getElementById('orderType').value;
      const side = document.getElementById('side').value;
      const traderId = document.getElementById('traderId').value;
      const price = parseFloat(document.getElementById('price').value);
      const qty = parseInt(document.getElementById('qty').value);

      if (orderType === 'LIMIT') {
        clob.placeLimitOrder(traderId, side, price, qty);
      } else {
        clob.placeMarketOrder(traderId, side, qty);
      }

      updateUI();
    };

    window.resetMarket = function() {
      clob.bids.clear();
      clob.asks.clear();
      clob.trades = [];
      clob.traders.set('alice', {cash: 10000, yesShares: 0});
      clob.traders.set('bob', {cash: 10000, yesShares: 0});
      clob.traders.set('carol', {cash: 10000, yesShares: 0});
      clob.traders.set('dave', {cash: 10000, yesShares: 0});
      updateUI();
    };

    // Initial UI update
    updateUI();

    // Add some sample orders for demonstration
    setTimeout(() => {
      console.log('Placing sample orders...');
      clob.placeLimitOrder('alice', 'SELL', 0.55, 10);
      updateUI();

      setTimeout(() => {
        clob.placeLimitOrder('bob', 'SELL', 0.50, 8);
        updateUI();
      }, 100);

      setTimeout(() => {
        clob.placeLimitOrder('dave', 'BUY', 0.45, 15);
        updateUI();
      }, 200);
    }, 500);
  </script>
</body>
</html>
