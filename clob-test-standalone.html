<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOB Order Book Tester</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #3b82f6;
        }

        .grid {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
        }

        .panel {
            background: #1e293b;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #334155;
        }

        .panel h2 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .control-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }

        input, select, button {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #0f172a;
            color: #e2e8f0;
            font-size: 14px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        button {
            cursor: pointer;
            font-weight: 500;
            transition: all 0.15s;
        }

        .btn-buy {
            background: #22c55e;
            border-color: #22c55e;
            color: #000;
        }

        .btn-buy:hover {
            background: #16a34a;
        }

        .btn-sell {
            background: #ef4444;
            border-color: #ef4444;
            color: #fff;
        }

        .btn-sell:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #475569;
            border-color: #475569;
        }

        .btn-secondary:hover {
            background: #64748b;
        }

        .orderbook {
            display: flex;
            flex-direction: column;
            height: 500px;
        }

        .ob-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            padding: 8px;
            background: #0f172a;
            border-radius: 6px 6px 0 0;
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
        }

        .ob-section {
            flex: 1;
            overflow-y: auto;
        }

        .ob-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            padding: 6px 8px;
            font-size: 13px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: background 0.1s;
        }

        .ob-row:hover {
            background: #334155;
        }

        .ob-row.bid {
            color: #22c55e;
        }

        .ob-row.ask {
            color: #ef4444;
        }

        .ob-spread {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
            background: #0f172a;
            border-top: 1px solid #334155;
            border-bottom: 1px solid #334155;
            font-weight: 600;
            font-size: 14px;
        }

        .market-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .data-point {
            background: #0f172a;
            padding: 10px;
            border-radius: 6px;
        }

        .data-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
        }

        .data-value {
            font-size: 18px;
            font-weight: 600;
            color: #3b82f6;
        }

        .log {
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            background: #0f172a;
            padding: 12px;
            border-radius: 6px;
        }

        .log-entry {
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px solid #1e293b;
        }

        .log-trade {
            color: #fbbf24;
        }

        .log-order {
            color: #94a3b8;
        }

        .log-cancel {
            color: #ef4444;
        }

        .depth-chart {
            height: 120px;
            background: #0f172a;
            border-radius: 6px;
            padding: 8px;
            margin-top: 12px;
            position: relative;
        }

        .traders-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .trader-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            font-size: 12px;
            border-bottom: 1px solid #334155;
        }

        .trader-id {
            color: #94a3b8;
        }

        .trader-balances {
            text-align: right;
        }

        .balance-cash {
            color: #fbbf24;
        }

        .balance-shares {
            color: #3b82f6;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .preset-btn {
            padding: 8px;
            font-size: 11px;
            background: #475569;
            border: none;
            color: #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
        }

        .preset-btn:hover {
            background: #64748b;
        }

        .order-info {
            font-size: 10px;
            color: #64748b;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“ˆ CLOB Order Book Tester</h1>

        <div class="grid">
            <!-- Left Panel: Controls -->
            <div class="panel">
                <h2>Place Order</h2>

                <div class="control-group">
                    <label>Trader ID</label>
                    <select id="traderSelect">
                        <option value="trader1">trader1</option>
                        <option value="trader2">trader2</option>
                        <option value="trader3">trader3</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>Order Type</label>
                    <select id="orderType" onchange="togglePriceInput()">
                        <option value="LIMIT">Limit Order</option>
                        <option value="MARKET">Market Order</option>
                    </select>
                </div>

                <div class="control-group" id="priceGroup">
                    <label>Price (0-100)</label>
                    <input type="number" id="price" value="50" step="1" min="0" max="100">
                </div>

                <div class="control-group">
                    <label>Quantity</label>
                    <input type="number" id="quantity" value="10" step="1" min="1">
                </div>

                <div class="control-group">
                    <button class="btn-buy" onclick="placeBuyOrder()">ðŸŸ¢ BUY</button>
                </div>

                <div class="control-group">
                    <button class="btn-sell" onclick="placeSellOrder()">ðŸ”´ SELL</button>
                </div>

                <h2 style="margin-top: 20px;">Cancel Order</h2>
                <div class="control-group">
                    <label>Order ID</label>
                    <input type="text" id="cancelOrderId" placeholder="e.g., 1">
                </div>
                <div class="control-group">
                    <button class="btn-secondary" onclick="cancelOrder()">Cancel Order</button>
                </div>

                <h2 style="margin-top: 20px;">Actions</h2>
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="loadThinMarket()">Thin Market</button>
                    <button class="preset-btn" onclick="loadThickMarket()">Thick Market</button>
                    <button class="preset-btn" onclick="loadCrossedBook()">Crossed Book</button>
                    <button class="preset-btn" onclick="loadFifoTest()">FIFO Test</button>
                    <button class="preset-btn" onclick="loadMarketableTest()">Marketable</button>
                    <button class="preset-btn" onclick="resetBook()">Reset Book</button>
                </div>
            </div>

            <!-- Center Panel: Order Book -->
            <div class="panel">
                <h2>Order Book (Price in cents)</h2>

                <div class="market-data">
                    <div class="data-point">
                        <div class="data-label">Best Bid</div>
                        <div class="data-value" id="bestBid">--</div>
                    </div>
                    <div class="data-point">
                        <div class="data-label">Best Ask</div>
                        <div class="data-value" id="bestAsk">--</div>
                    </div>
                    <div class="data-point">
                        <div class="data-label">Spread</div>
                        <div class="data-value" id="spread">--</div>
                    </div>
                    <div class="data-point">
                        <div class="data-label">Mid Price</div>
                        <div class="data-value" id="midPrice">--</div>
                    </div>
                    <div class="data-point">
                        <div class="data-label">Bid Depth (3)</div>
                        <div class="data-value" id="bidDepth">--</div>
                    </div>
                    <div class="data-point">
                        <div class="data-label">Ask Depth (3)</div>
                        <div class="data-value" id="askDepth">--</div>
                    </div>
                </div>

                <div class="orderbook">
                    <div class="ob-header">
                        <span style="text-align: right">Bid Qty</span>
                        <span style="text-align: center">Price</span>
                        <span>Ask Qty</span>
                    </div>

                    <div class="ob-section" id="asks"></div>

                    <div class="ob-spread" id="spreadDisplay">
                        Spread: <span id="spreadValue">--</span> |
                        Mid: <span id="midValue">--</span>
                    </div>

                    <div class="ob-section" id="bids"></div>
                </div>

                <div class="depth-chart" id="depthChart"></div>
            </div>

            <!-- Right Panel: Traders & Logs -->
            <div class="panel">
                <h2>Trader States</h2>
                <div class="traders-list" id="tradersList"></div>

                <h2 style="margin-top: 16px;">Open Orders</h2>
                <div id="openOrdersList" style="max-height: 150px; overflow-y: auto; font-size: 11px;"></div>

                <h2 style="margin-top: 16px;">Event Log</h2>
                <div class="log" id="eventLog"></div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // Mini CLOB Engine - Simplified for browser testing
        // ============================================================================

        class MiniCLOB {
            constructor() {
                this.bids = new Map();  // price -> {totalQty, orders: []}
                this.asks = new Map();  // price -> {totalQty, orders: []}
                this.trades = [];
                this.orderIdCounter = 0;
                this.tradeIdCounter = 0;
                this.traders = new Map();
                this.openOrders = new Map();  // orderId -> order
            }

            addTrader(id, cash) {
                if (!this.traders.has(id)) {
                    this.traders.set(id, { id, cash, shares: 0 });
                }
            }

            getTrader(id) {
                return this.traders.get(id);
            }

            // Price as integer (cents) for exact comparison
            placeLimitOrder(traderId, side, price, qty) {
                this.addTrader(traderId, 0);  // Ensure trader exists

                const orderId = ++this.orderIdCounter;
                const order = { orderId, traderId, side, price, qty, originalQty: qty, timestamp: Date.now() };

                let trades = [];
                let remainingQty = qty;

                if (side === 'BUY') {
                    // Check if we can cross with asks
                    const askPrices = Array.from(this.asks.keys()).map(Number).sort((a, b) => a - b);

                    for (const askPrice of askPrices) {
                        if (remainingQty <= 0) break;
                        if (price >= askPrice) {
                            // Cross with this ask level
                            const askLevel = this.asks.get(String(askPrice));

                            while (askLevel.orders.length > 0 && remainingQty > 0) {
                                const askOrder = askLevel.orders[0];  // FIFO - first in queue

                                const tradeQty = Math.min(remainingQty, askOrder.qty);
                                const tradePrice = askPrice;  // Use ask's price (maker's price)

                                trades.push({
                                    tradeId: ++this.tradeIdCounter,
                                    price: tradePrice,
                                    qty: tradeQty,
                                    bidOrderId: orderId,
                                    askOrderId: askOrder.orderId,
                                    bidTraderId: traderId,
                                    askTraderId: askOrder.traderId,
                                    timestamp: Date.now()
                                });

                                // Update ask order
                                askOrder.qty -= tradeQty;
                                remainingQty -= tradeQty;
                                askLevel.totalQty -= tradeQty;

                                // Update trader balances
                                const bidTrader = this.traders.get(traderId);
                                const askTrader = this.traders.get(askOrder.traderId);
                                bidTrader.shares += tradeQty;
                                bidTrader.cash -= tradeQty * tradePrice;
                                askTrader.shares -= tradeQty;
                                askTrader.cash += tradeQty * tradePrice;

                                if (askOrder.qty === 0) {
                                    askLevel.orders.shift();
                                    this.openOrders.delete(askOrder.orderId);
                                }
                            }

                            // Clean up empty level
                            if (askLevel.orders.length === 0) {
                                this.asks.delete(String(askPrice));
                            }
                        } else {
                            break;  // Price too low for more asks
                        }
                    }

                    // Add remaining to bids
                    if (remainingQty > 0) {
                        order.qty = remainingQty;
                        const priceKey = String(price);
                        if (!this.bids.has(priceKey)) {
                            this.bids.set(priceKey, { totalQty: 0, orders: [] });
                        }
                        const level = this.bids.get(priceKey);
                        level.orders.push(order);
                        level.totalQty += remainingQty;
                        this.openOrders.set(orderId, order);
                    }
                } else {
                    // SELL - similar logic but crossing with bids
                    const bidPrices = Array.from(this.bids.keys()).map(Number).sort((a, b) => b - a);

                    for (const bidPrice of bidPrices) {
                        if (remainingQty <= 0) break;
                        if (price <= bidPrice) {
                            const bidLevel = this.bids.get(String(bidPrice));

                            while (bidLevel.orders.length > 0 && remainingQty > 0) {
                                const bidOrder = bidLevel.orders[0];

                                const tradeQty = Math.min(remainingQty, bidOrder.qty);
                                const tradePrice = bidPrice;

                                trades.push({
                                    tradeId: ++this.tradeIdCounter,
                                    price: tradePrice,
                                    qty: tradeQty,
                                    bidOrderId: bidOrder.orderId,
                                    askOrderId: orderId,
                                    bidTraderId: bidOrder.traderId,
                                    askTraderId: traderId,
                                    timestamp: Date.now()
                                });

                                bidOrder.qty -= tradeQty;
                                remainingQty -= tradeQty;
                                bidLevel.totalQty -= tradeQty;

                                const bidTrader = this.traders.get(bidOrder.traderId);
                                const askTrader = this.traders.get(traderId);
                                bidTrader.shares += tradeQty;
                                bidTrader.cash -= tradeQty * tradePrice;
                                askTrader.shares -= tradeQty;
                                askTrader.cash += tradeQty * tradePrice;

                                if (bidOrder.qty === 0) {
                                    bidLevel.orders.shift();
                                    this.openOrders.delete(bidOrder.orderId);
                                }
                            }

                            if (bidLevel.orders.length === 0) {
                                this.bids.delete(String(bidPrice));
                            }
                        } else {
                            break;
                        }
                    }

                    if (remainingQty > 0) {
                        order.qty = remainingQty;
                        const priceKey = String(price);
                        if (!this.asks.has(priceKey)) {
                            this.asks.set(priceKey, { totalQty: 0, orders: [] });
                        }
                        const level = this.asks.get(priceKey);
                        level.orders.push(order);
                        level.totalQty += remainingQty;
                        this.openOrders.set(orderId, order);
                    }
                }

                this.trades.push(...trades);
                return { orderId, status: remainingQty < qty ? 'PARTIALLY_FILLED' : (remainingQty === qty ? 'OPEN' : 'FILLED'), trades, filledQty: qty - remainingQty, remainingQty };
            }

            placeMarketOrder(traderId, side, qty) {
                this.addTrader(traderId, 0);

                const orderId = ++this.orderIdCounter;
                let trades = [];
                let remainingQty = qty;

                if (side === 'BUY') {
                    // Cross with asks from best up
                    const askPrices = Array.from(this.asks.keys()).map(Number).sort((a, b) => a - b);

                    for (const askPrice of askPrices) {
                        if (remainingQty <= 0) break;
                        const askLevel = this.asks.get(String(askPrice));

                        while (askLevel.orders.length > 0 && remainingQty > 0) {
                            const askOrder = askLevel.orders[0];
                            const tradeQty = Math.min(remainingQty, askOrder.qty);

                            trades.push({
                                tradeId: ++this.tradeIdCounter,
                                price: askPrice,
                                qty: tradeQty,
                                bidOrderId: orderId,
                                askOrderId: askOrder.orderId,
                                bidTraderId: traderId,
                                askTraderId: askOrder.traderId,
                                timestamp: Date.now()
                            });

                            askOrder.qty -= tradeQty;
                            remainingQty -= tradeQty;
                            askLevel.totalQty -= tradeQty;

                            const bidTrader = this.traders.get(traderId);
                            const askTrader = this.traders.get(askOrder.traderId);
                            bidTrader.shares += tradeQty;
                            bidTrader.cash -= tradeQty * askPrice;
                            askTrader.shares -= tradeQty;
                            askTrader.cash += tradeQty * askPrice;

                            if (askOrder.qty === 0) {
                                askLevel.orders.shift();
                                this.openOrders.delete(askOrder.orderId);
                            }
                        }

                        if (askLevel.orders.length === 0) {
                            this.asks.delete(String(askPrice));
                        }
                    }
                } else {
                    const bidPrices = Array.from(this.bids.keys()).map(Number).sort((a, b) => b - a);

                    for (const bidPrice of bidPrices) {
                        if (remainingQty <= 0) break;
                        const bidLevel = this.bids.get(String(bidPrice));

                        while (bidLevel.orders.length > 0 && remainingQty > 0) {
                            const bidOrder = bidLevel.orders[0];
                            const tradeQty = Math.min(remainingQty, bidOrder.qty);

                            trades.push({
                                tradeId: ++this.tradeIdCounter,
                                price: bidPrice,
                                qty: tradeQty,
                                bidOrderId: bidOrder.orderId,
                                askOrderId: orderId,
                                bidTraderId: bidOrder.traderId,
                                askTraderId: traderId,
                                timestamp: Date.now()
                            });

                            bidOrder.qty -= tradeQty;
                            remainingQty -= tradeQty;
                            bidLevel.totalQty -= tradeQty;

                            const bidTrader = this.traders.get(bidOrder.traderId);
                            const askTrader = this.traders.get(traderId);
                            bidTrader.shares += tradeQty;
                            bidTrader.cash -= tradeQty * bidPrice;
                            askTrader.shares -= tradeQty;
                            askTrader.cash += tradeQty * bidPrice;

                            if (bidOrder.qty === 0) {
                                bidLevel.orders.shift();
                                this.openOrders.delete(bidOrder.orderId);
                            }
                        }

                        if (bidLevel.orders.length === 0) {
                            this.bids.delete(String(bidPrice));
                        }
                    }
                }

                this.trades.push(...trades);
                return { orderId, status: remainingQty < qty ? 'PARTIALLY_FILLED' : (remainingQty === 0 ? 'FILLED' : 'REJECTED'), trades, filledQty: qty - remainingQty, remainingQty };
            }

            cancelOrder(orderId) {
                const order = this.openOrders.get(Number(orderId));
                if (!order) {
                    return { orderId: Number(orderId), status: 'REJECTED', trades: [], filledQty: 0, remainingQty: 0 };
                }

                const map = order.side === 'BUY' ? this.bids : this.asks;
                const level = map.get(String(order.price));

                if (level) {
                    const idx = level.orders.findIndex(o => o.orderId === Number(orderId));
                    if (idx !== -1) {
                        level.orders.splice(idx, 1);
                        level.totalQty -= order.qty;
                        if (level.orders.length === 0) {
                            map.delete(String(order.price));
                        }
                    }
                }

                this.openOrders.delete(Number(orderId));
                return { orderId: Number(orderId), status: 'CANCELLED', trades: [], filledQty: 0, remainingQty: order.qty };
            }

            getBestBid() {
                const prices = Array.from(this.bids.keys()).map(Number);
                if (prices.length === 0) return null;
                return Math.max(...prices);
            }

            getBestAsk() {
                const prices = Array.from(this.asks.keys()).map(Number);
                if (prices.length === 0) return null;
                return Math.min(...prices);
            }

            getSpread() {
                const bid = this.getBestBid();
                const ask = this.getBestAsk();
                if (bid === null || ask === null) return null;
                return ask - bid;
            }

            getMidPrice() {
                const bid = this.getBestBid();
                const ask = this.getBestAsk();
                if (bid === null || ask === null) return null;
                return (bid + ask) / 2;
            }

            getDepth(side, ticks) {
                const map = side === 'BUY' ? this.bids : this.asks;
                const prices = side === 'BUY'
                    ? Array.from(map.keys()).map(Number).sort((a, b) => b - a)
                    : Array.from(map.keys()).map(Number).sort((a, b) => a - b);

                let total = 0;
                for (let i = 0; i < Math.min(ticks, prices.length); i++) {
                    total += map.get(String(prices[i])).totalQty;
                }
                return total;
            }

            getOpenOrders() {
                return Array.from(this.openOrders.values());
            }
        }

        // ============================================================================
        // App State
        // ============================================================================

        const clob = new MiniCLOB();

        // Initialize traders with starting cash
        clob.addTrader('trader1', 10000);
        clob.addTrader('trader2', 10000);
        clob.addTrader('trader3', 10000);

        function updateDisplay() {
            const bestBid = clob.getBestBid();
            const bestAsk = clob.getBestAsk();
            const spread = clob.getSpread();
            const midPrice = clob.getMidPrice();
            const bidDepth = clob.getDepth('BUY', 3);
            const askDepth = clob.getDepth('SELL', 3);

            document.getElementById('bestBid').textContent = bestBid !== null ? bestBid : '--';
            document.getElementById('bestAsk').textContent = bestAsk !== null ? bestAsk : '--';
            document.getElementById('spread').textContent = spread !== null ? spread : '--';
            document.getElementById('midPrice').textContent = midPrice !== null ? midPrice.toFixed(1) : '--';
            document.getElementById('bidDepth').textContent = bidDepth;
            document.getElementById('askDepth').textContent = askDepth;
            document.getElementById('spreadValue').textContent = spread !== null ? spread : '--';
            document.getElementById('midValue').textContent = midPrice !== null ? midPrice.toFixed(1) : '--';

            updateOrderBook();
            updateTraders();
            updateOpenOrders();
            updateDepthChart();
        }

        function updateOrderBook() {
            const asksContainer = document.getElementById('asks');
            const bidsContainer = document.getElementById('bids');

            // Get asks (ascending)
            const askPrices = Array.from(clob.asks.keys()).map(Number).sort((a, b) => a - b);
            // Get bids (descending)
            const bidPrices = Array.from(clob.bids.keys()).map(Number).sort((a, b) => b - a);

            // Render asks (reversed - highest at top)
            asksContainer.innerHTML = '';
            for (let i = askPrices.length - 1; i >= Math.max(0, askPrices.length - 8); i--) {
                const price = askPrices[i];
                const level = clob.asks.get(String(price));
                const row = document.createElement('div');
                row.className = 'ob-row ask';
                row.innerHTML = `
                    <div style="text-align: right"></div>
                    <div style="text-align: center; font-weight: 600;">${price}</div>
                    <div>${level.totalQty}</div>
                `;
                row.title = level.orders.map(o => `ID:${o.orderId} (${o.qty})`).join('\n');
                asksContainer.appendChild(row);
            }

            // Render bids
            bidsContainer.innerHTML = '';
            for (let i = 0; i < Math.min(bidPrices.length, 8); i++) {
                const price = bidPrices[i];
                const level = clob.bids.get(String(price));
                const row = document.createElement('div');
                row.className = 'ob-row bid';
                row.innerHTML = `
                    <div style="text-align: right">${level.totalQty}</div>
                    <div style="text-align: center; font-weight: 600;">${price}</div>
                    <div></div>
                `;
                row.title = level.orders.map(o => `ID:${o.orderId} (${o.qty})`).join('\n');
                bidsContainer.appendChild(row);
            }

            if (askPrices.length === 0 && bidPrices.length === 0) {
                asksContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">No orders - click a preset to load sample orders</div>';
            }
        }

        function updateTraders() {
            const container = document.getElementById('tradersList');
            container.innerHTML = '';

            for (const [id, trader] of clob.traders) {
                const row = document.createElement('div');
                row.className = 'trader-row';
                row.innerHTML = `
                    <div>
                        <div class="trader-id">${id}</div>
                    </div>
                    <div class="trader-balances">
                        <div class="balance-cash">ðŸ’° $${trader.cash.toFixed(2)}</div>
                        <div class="balance-shares">ðŸ“ˆ Shares: ${trader.shares.toFixed(1)}</div>
                    </div>
                `;
                container.appendChild(row);
            }
        }

        function updateOpenOrders() {
            const container = document.getElementById('openOrdersList');
            const orders = clob.getOpenOrders();
            container.innerHTML = '';

            if (orders.length === 0) {
                container.innerHTML = '<div style="padding: 8px; color: #64748b; font-size: 11px;">No open orders</div>';
                return;
            }

            for (const order of orders) {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 4px 8px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between;';
                div.innerHTML = `
                    <span style="color: ${order.side === 'BUY' ? '#22c55e' : '#ef4444'}">${order.side} ${order.price}</span>
                    <span style="color: #94a3b8;">ID:${order.orderId} | ${order.qty} @ ${order.traderId}</span>
                `;
                container.appendChild(div);
            }
        }

        function updateDepthChart() {
            const container = document.getElementById('depthChart');
            container.innerHTML = '';

            const bidPrices = Array.from(clob.bids.keys()).map(Number).sort((a, b) => b - a);
            const askPrices = Array.from(clob.asks.keys()).map(Number).sort((a, b) => a - b);

            if (bidPrices.length === 0 && askPrices.length === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #64748b; font-size: 12px;">No depth data</div>';
                return;
            }

            const allPrices = [...bidPrices, ...askPrices];
            const minPrice = Math.min(...allPrices);
            const maxPrice = Math.max(...allPrices);

            const maxQty = Math.max(
                ...bidPrices.map(p => clob.bids.get(String(p)).totalQty),
                ...askPrices.map(p => clob.asks.get(String(p)).totalQty)
            );

            const width = container.clientWidth;
            const barWidth = Math.max(4, Math.min(15, width / (maxPrice - minPrice + 1)));

            // Draw center line
            const centerLine = document.createElement('div');
            centerLine.style.cssText = 'position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: #334155;';
            container.appendChild(centerLine);

            // Draw bids (green, growing from center left)
            for (const price of bidPrices) {
                const level = clob.bids.get(String(price));
                const bar = document.createElement('div');
                const height = (level.totalQty / maxQty) * 100;
                const offset = ((price - minPrice) / (maxPrice - minPrice + 1)) * width;

                bar.className = 'depth-bar bid';
                bar.style.cssText = `
                    position: absolute;
                    left: ${offset}px;
                    width: ${barWidth}px;
                    bottom: 0;
                    height: ${height}%;
                    background: rgba(34, 197, 94, 0.6);
                    border-radius: 2px 0 0 2px;
                `;
                bar.title = `Bid: ${price}, Qty: ${level.totalQty}`;
                container.appendChild(bar);
            }

            // Draw asks (red, growing from center right)
            for (const price of askPrices) {
                const level = clob.asks.get(String(price));
                const bar = document.createElement('div');
                const height = (level.totalQty / maxQty) * 100;
                const offset = ((price - minPrice) / (maxPrice - minPrice + 1)) * width;

                bar.className = 'depth-bar ask';
                bar.style.cssText = `
                    position: absolute;
                    left: ${offset}px;
                    width: ${barWidth}px;
                    bottom: 0;
                    height: ${height}%;
                    background: rgba(239, 68, 68, 0.6);
                    border-radius: 0 2px 2px 0;
                `;
                bar.title = `Ask: ${price}, Qty: ${level.totalQty}`;
                container.appendChild(bar);
            }
        }

        function log(type, message) {
            const logContainer = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';

            let typeClass = 'log-order';
            if (type === 'TRADE') typeClass = 'log-trade';
            if (type === 'CANCEL') typeClass = 'log-cancel';

            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span style="color: #64748b;">[${time}]</span> <span class="${typeClass}">${type}:</span> ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);

            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function placeBuyOrder() {
            const traderId = document.getElementById('traderSelect').value;
            const orderType = document.getElementById('orderType').value;
            const price = parseInt(document.getElementById('price').value);
            const qty = parseInt(document.getElementById('quantity').value);

            if (orderType === 'MARKET') {
                const result = clob.placeMarketOrder(traderId, 'BUY', qty);
                log('MARKET BUY', `Trader: ${traderId}, Qty: ${qty}, Filled: ${result.filledQty}`);
                if (result.trades.length > 0) {
                    result.trades.forEach(t => {
                        log('TRADE', `Price: ${t.price}, Qty: ${t.qty}`);
                    });
                }
            } else {
                const result = clob.placeLimitOrder(traderId, 'BUY', price, qty);
                log('LIMIT BUY', `ID: ${result.orderId}, Price: ${price}, Qty: ${qty}, Status: ${result.status}`);
                if (result.trades.length > 0) {
                    result.trades.forEach(t => {
                        log('TRADE', `Price: ${t.price}, Qty: ${t.qty}`);
                    });
                }
            }
            updateDisplay();
        }

        function placeSellOrder() {
            const traderId = document.getElementById('traderSelect').value;
            const orderType = document.getElementById('orderType').value;
            const price = parseInt(document.getElementById('price').value);
            const qty = parseInt(document.getElementById('quantity').value);

            if (orderType === 'MARKET') {
                const result = clob.placeMarketOrder(traderId, 'SELL', qty);
                log('MARKET SELL', `Trader: ${traderId}, Qty: ${qty}, Filled: ${result.filledQty}`);
                if (result.trades.length > 0) {
                    result.trades.forEach(t => {
                        log('TRADE', `Price: ${t.price}, Qty: ${t.qty}`);
                    });
                }
            } else {
                const result = clob.placeLimitOrder(traderId, 'SELL', price, qty);
                log('LIMIT SELL', `ID: ${result.orderId}, Price: ${price}, Qty: ${qty}, Status: ${result.status}`);
                if (result.trades.length > 0) {
                    result.trades.forEach(t => {
                        log('TRADE', `Price: ${t.price}, Qty: ${t.qty}`);
                    });
                }
            }
            updateDisplay();
        }

        function cancelOrder() {
            const orderId = document.getElementById('cancelOrderId').value;
            if (!orderId) {
                alert('Please enter an Order ID');
                return;
            }
            const result = clob.cancelOrder(orderId);
            log('CANCEL', `ID: ${orderId}, Status: ${result.status}`);
            updateDisplay();
        }

        function togglePriceInput() {
            const orderType = document.getElementById('orderType').value;
            const priceGroup = document.getElementById('priceGroup');
            priceGroup.style.display = orderType === 'MARKET' ? 'none' : 'block';
        }

        function resetBook() {
            clob.bids.clear();
            clob.asks.clear();
            clob.trades = [];
            clob.openOrders.clear();
            clob.traders.clear();
            clob.orderIdCounter = 0;
            clob.tradeIdCounter = 0;

            clob.addTrader('trader1', 10000);
            clob.addTrader('trader2', 10000);
            clob.addTrader('trader3', 10000);

            log('System', 'Book reset');
            updateDisplay();
        }

        function loadThinMarket() {
            resetBook();
            clob.placeLimitOrder('trader1', 'SELL', 55, 5);
            clob.placeLimitOrder('trader2', 'SELL', 60, 3);
            clob.placeLimitOrder('trader1', 'BUY', 45, 8);
            clob.placeLimitOrder('trader3', 'BUY', 40, 5);
            log('System', 'Loaded thin market preset');
            updateDisplay();
        }

        function loadThickMarket() {
            resetBook();
            clob.placeLimitOrder('trader1', 'SELL', 51, 20);
            clob.placeLimitOrder('trader2', 'SELL', 52, 25);
            clob.placeLimitOrder('trader1', 'SELL', 53, 15);
            clob.placeLimitOrder('trader3', 'SELL', 54, 30);
            clob.placeLimitOrder('trader2', 'SELL', 55, 20);
            clob.placeLimitOrder('trader1', 'BUY', 50, 25);
            clob.placeLimitOrder('trader2', 'BUY', 49, 20);
            clob.placeLimitOrder('trader3', 'BUY', 48, 15);
            clob.placeLimitOrder('trader1', 'BUY', 47, 30);
            clob.placeLimitOrder('trader2', 'BUY', 46, 20);
            log('System', 'Loaded thick market preset');
            updateDisplay();
        }

        function loadCrossedBook() {
            resetBook();
            log('System', 'Placing crossed orders...');
            clob.placeLimitOrder('trader1', 'BUY', 55, 10);
            clob.placeLimitOrder('trader2', 'SELL', 52, 8);
            log('System', 'Crossed book - buy @55 should cross with sell @52');
            updateDisplay();
        }

        function loadFifoTest() {
            resetBook();
            log('System', 'Testing FIFO priority...');
            log('System', 'Placing 3 buy orders @50 (trader1, trader2, trader3)');
            clob.placeLimitOrder('trader1', 'BUY', 50, 10);
            clob.placeLimitOrder('trader2', 'BUY', 50, 5);
            clob.placeLimitOrder('trader3', 'BUY', 50, 8);
            log('System', 'Now placing sell @50 for 15 qty...');
            log('System', 'Should fill trader1 (10) then trader2 (5), trader3 should remain with 8');
            clob.placeLimitOrder('trader1', 'SELL', 50, 15);
            updateDisplay();
        }

        function loadMarketableTest() {
            resetBook();
            log('System', 'Testing marketable limit orders...');
            clob.placeLimitOrder('trader1', 'SELL', 50, 10);
            clob.placeLimitOrder('trader2', 'SELL', 52, 8);
            log('System', 'Asks at 50 and 52. Placing buy @54...');
            clob.placeLimitOrder('trader3', 'BUY', 54, 12);
            log('System', 'Should cross with both asks immediately');
            updateDisplay();
        }

        // Initial display
        updateDisplay();
        log('System', 'CLOB Order Book Tester initialized. Click a preset to load orders.');
    </script>
</body>
</html>
